name: Build WebDriverAgent

on:
  workflow_dispatch:
    inputs:
      ios_version:
        description: 'Target iOS version'
        required: false
        default: '18.5'
      bundle_id_suffix:
        description: 'Bundle ID suffix (to make it unique)'
        required: false
        default: 'myautomation'

jobs:
  build-wda:
    runs-on: macos-14  # macOS Sonoma with Xcode 15+
    
    steps:
      - name: Show Xcode versions
        run: |
          echo "Available Xcode versions:"
          ls -la /Applications/ | grep Xcode
          xcodebuild -version
          
      - name: Clone WebDriverAgent
        run: |
          git clone https://github.com/appium/WebDriverAgent.git
          cd WebDriverAgent
          git log -1 --oneline
          
      - name: Setup Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          
      - name: Install Fastlane
        run: |
          gem install fastlane
          
      - name: Install Apple Certificate
        env:
          P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Decode certificate
          echo -n "$P12_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
      - name: Install Provisioning Profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Decode provisioning profile
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
          
      - name: Update Bundle Identifiers
        run: |
          cd WebDriverAgent
          
          SUFFIX="${{ github.event.inputs.bundle_id_suffix }}"
          
          # Update WebDriverAgentLib bundle ID
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com.facebook.WebDriverAgentLib;/PRODUCT_BUNDLE_IDENTIFIER = com.${SUFFIX}.WebDriverAgentLib;/g" WebDriverAgent.xcodeproj/project.pbxproj
          
          # Update WebDriverAgentRunner bundle ID  
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com.facebook.WebDriverAgentRunner;/PRODUCT_BUNDLE_IDENTIFIER = com.${SUFFIX}.WebDriverAgentRunner;/g" WebDriverAgent.xcodeproj/project.pbxproj
          
          # Update IntegrationApp bundle ID
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com.facebook.IntegrationApp;/PRODUCT_BUNDLE_IDENTIFIER = com.${SUFFIX}.IntegrationApp;/g" WebDriverAgent.xcodeproj/project.pbxproj
          
          echo "Updated bundle identifiers with suffix: $SUFFIX"
          
      - name: Build WebDriverAgent
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd WebDriverAgent
          
          # Build for generic iOS device
          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="Apple Development" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            -allowProvisioningUpdates
            
      - name: Package WDA
        run: |
          cd WebDriverAgent
          
          # Find the built products
          WDA_RUNNER_PATH=$(find ./build -name "WebDriverAgentRunner-Runner.app" -type d | head -1)
          
          if [ -z "$WDA_RUNNER_PATH" ]; then
            echo "WebDriverAgentRunner-Runner.app not found!"
            find ./build -name "*.app" -type d
            exit 1
          fi
          
          echo "Found WDA at: $WDA_RUNNER_PATH"
          
          # Create IPA
          mkdir -p Payload
          cp -r "$WDA_RUNNER_PATH" Payload/
          zip -r WebDriverAgent.ipa Payload
          
          echo "Created WebDriverAgent.ipa"
          ls -la WebDriverAgent.ipa
          
      - name: Upload WDA IPA
        uses: actions/upload-artifact@v4
        with:
          name: WebDriverAgent-${{ github.event.inputs.bundle_id_suffix }}
          path: WebDriverAgent/WebDriverAgent.ipa
          retention-days: 30
          
      - name: Upload Build Products
        uses: actions/upload-artifact@v4
        with:
          name: WDA-Build-Products
          path: |
            WebDriverAgent/build/Build/Products/Debug-iphoneos/
          retention-days: 30
          
      - name: Cleanup
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -f $RUNNER_TEMP/certificate.p12 || true
          rm -f $RUNNER_TEMP/profile.mobileprovision || true
